---
import Layout from '../../layouts/Layout.astro';
import Template from '../../components/sections/projects/template/Template.astro';
import { PayloadAPI, type PayloadProject, getImageUrl, renderRichText } from '../../lib/payload';
import { getLangFromUrl } from '../../i18n/utils';
import { translations } from '../../i18n/translations';

export const prerender = false;

// Fetch project dynamically on each request
const { slug } = Astro.params;
let project: PayloadProject | null = null;
const locale = 'es';

try {
  const projects = await PayloadAPI.getProjects('es');
  project = projects.find(p => p.slug === slug) || null;
} catch (error) {
  console.error('❌ Error fetching project:', error);
}

// Detect current language
const currentLang = getLangFromUrl(Astro.url) || locale;
const t = translations[currentLang];

// Fallback data in case project is not found
const exampleData = {
  projectTitle: "Proyecto de Ejemplo",
  projectCategories: ["Diseño UX/UI", "Desarrollo Web"],
  projectDescription: "Un proyecto de ejemplo para demostrar la funcionalidad.",
  caseStudyTitle: "Caso de Estudio - Proyecto de Ejemplo",
  caseStudyContent: "Este es un ejemplo de contenido de caso de estudio.",
  mainImage: undefined,
  mainImageAlt: "Imagen de ejemplo",
  servicesTitle: "Los que hicimos:",
  services: [
    { name: "Diseño UX/UI" },
    { name: "Desarrollo Frontend" }
  ],
  learningTitle: "Nuestros Aprendizajes",
  learningContent: "Contenido de aprendizajes de ejemplo.",
  publishDate: new Date(),
  featured: false,
  status: "published"
};

// Transform Payload project to template format
const projectData = project ? {
  projectTitle: project.title,
  projectCategories: [project.category.name],
  projectDescription: renderRichText(project.hero.description),
  bannerImage: getImageUrl(project.hero.bannerImage?.url),
  caseStudyTitle: project.caseStudy?.title,
  caseStudyContent: renderRichText(project.caseStudy?.content),
  mainImage: project.gallery && project.gallery.length > 0 ? getImageUrl(project.gallery[0].image?.url) : undefined,
  mainImageAlt: project.gallery && project.gallery.length > 0 ? project.gallery[0].alt : undefined,
  servicesTitle: currentLang === 'en' ? "What we did:" : "Los que hicimos:",
  services: project.hero.services.map(service => ({ name: service.name })),
  learningTitle: project.learnings.title,
  learningContent: renderRichText(project.learnings.content),
} : exampleData;

// SEO
const seoTitle = `${projectData.projectTitle} - Aurin`;
const seoDescription = projectData.projectDescription || "Proyecto desarrollado por Aurin";
---

<Layout
  title={seoTitle}
  description={seoDescription}
>
  <Template
    projectData={projectData}
  />
</Layout>
