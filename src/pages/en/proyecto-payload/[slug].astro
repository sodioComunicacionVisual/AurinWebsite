---
import Layout from '../../../layouts/Layout.astro';
import Template from '../../../components/sections/projects/template/Template.astro';
import { PayloadAPI, type PayloadProject, getImageUrl, renderRichText } from '../../../lib/payload';
import { getLangFromUrl } from '../../../i18n/utils';
import { translations } from '../../../i18n/translations';

export const prerender = false;

// Detect current language first
const currentLang = getLangFromUrl(Astro.url);

// Fetch project dynamically on each request
const { slug } = Astro.params;
let project: PayloadProject | null = null;

try {
  const projects = await PayloadAPI.getProjects(currentLang);
  project = projects.find(p => p.slug === slug) || null;
} catch (error) {
  console.error('âŒ Error fetching project:', error);
}

const t = translations[currentLang];

// Fallback data in case project is not found
const exampleData = {
  projectTitle: "Example Project",
  projectCategories: ["UX/UI Design", "Web Development"],
  projectDescription: "An example project to demonstrate functionality.",
  gallery: [],
  publishDate: new Date(),
  featured: false,
  status: "published"
};

// Transform Payload project to template format
const projectData = project ? {
  projectTitle: project.title,
  projectCategories: project.hero.services?.map(service => service.name) || [],
  projectDescription: renderRichText(project.hero.description),
  bannerImage: getImageUrl(project.client?.logo?.url) || getImageUrl(project.hero.bannerImage?.url),
  gallery: project.gallery?.map(item => ({
    imgUrl: getImageUrl(item.image?.url),
    alt: item.alt || project.title
  })) || [],
} : exampleData;

// SEO
const seoTitle = `${projectData.projectTitle} - Aurin`;
const seoDescription = projectData.projectDescription || "Project developed by Aurin";
---

<Layout
  title={seoTitle}
  description={seoDescription}
>
  <Template
    projectData={projectData}
  />
</Layout>
